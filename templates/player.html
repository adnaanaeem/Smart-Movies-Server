<!DOCTYPE html>
<html>
<head>
    <title>{{ meta.title if meta.title else filename }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <style>
        body { background: #0f0f0f; color: white; margin: 0; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* PLAYER SECTION */
        .player-container { 
            width: 100%; height: 65vh; background: black; 
            display: flex; align-items: center; justify-content: center; position: relative; 
        }
        video { width: 100%; height: 100%; max-height: 100%; outline: none; }
        
        /* BACK BUTTON */
        .back-btn {
            position: absolute; top: 30px; left: 30px; z-index: 20;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white; text-decoration: none; 
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; padding-bottom: 4px; transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .back-btn:hover { background: white; color: black; transform: scale(1.1); }

        /* INFO SECTION */
        .info-container {
            position: relative; padding: 40px;
            background-image: url('{{ meta.backdrop }}');
            background-size: cover; background-position: center;
            min-height: 40vh; box-shadow: inset 0 50px 100px #0f0f0f;
        }
        .info-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, #0f0f0f 10%, rgba(15,15,15,0.9) 100%);
            z-index: 1;
        }

        .content { position: relative; z-index: 2; display: flex; gap: 30px; max-width: 1200px; margin: auto; }
        
        .poster-card {
            width: 180px; height: 270px; flex-shrink: 0;
            border-radius: 10px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .poster-card img { width: 100%; height: 100%; object-fit: cover; }

        .text-details { flex-grow: 1; }
        h1 { margin: 0; font-size: 32px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        
        .raw-filename {
            font-family: 'Consolas', monospace; font-size: 13px; color: #888; margin: 5px 0 15px 0; word-break: break-all;
        }

        .meta-row { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; color: #aaa; font-size: 14px; flex-wrap: wrap; }
        .badge { border: 1px solid #444; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; color: #ccc; background: rgba(0,0,0,0.3); }
        .quality-badge { border-color: #e50914; color: #e50914; }
        .rating { color: #46d369; font-weight: bold; font-size: 16px; margin-right: 10px; }
        
        .plot { line-height: 1.6; color: #ccc; font-size: 15px; max-width: 800px; margin-bottom: 25px; text-shadow: 0 1px 2px black; }

        .actions { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .btn {
            background: #222; color: white; border: 1px solid #444;
            padding: 10px 20px; border-radius: 6px; text-decoration: none;
            display: inline-flex; align-items: center; gap: 8px; font-weight: bold; font-size: 13px;
            transition: 0.2s; cursor: pointer;
        }
        .btn:hover { background: #333; border-color: white; }
        .btn-vlc { border-color: #ff8800; color: #ff8800; }
        .btn-vlc:hover { background: #ff8800; color: white; }
        .btn-dl { border-color: #00aaff; color: #00aaff; }
        .btn-dl:hover { background: #00aaff; color: white; }

        @media (max-width: 768px) {
            .player-container { height: 40vh; }
            .content { flex-direction: column; align-items: center; text-align: center; }
            .poster-card { display: none; }
            .meta-row { justify-content: center; }
            .actions { justify-content: center; }
        }
        
        #resume-msg { position:absolute; top: 80px; left: 30px; background: rgba(0,0,0,0.8); color: #fff; padding: 8px 12px; border-radius: 5px; display: none; z-index: 20; font-size: 13px; border: 1px solid #444; }
    </style>
</head>
<body>

    <div class="player-container">
        <a href="javascript:history.back()" class="back-btn" title="Back">‚¨Ö</a>
        <div id="resume-msg">Resuming playback...</div>
        
        <video id="videoPlayer" controls autoplay crossorigin="anonymous">
            <source src="/download/{{ filepath }}">
            {% for sub in subtitles %}
                <track label="{{ sub.label }}" kind="subtitles" srclang="{{ sub.lang }}" src="{{ sub.src }}" {% if loop.first %}default{% endif %}>
            {% endfor %}
        </video>
    </div>

    <div class="info-container">
        <div class="info-overlay"></div>
        <div class="content">
            {% if meta.poster %}
            <div class="poster-card">
                <img src="{{ meta.poster }}">
            </div>
            {% endif %}

            <div class="text-details">
                <h1>{{ meta.title if meta.title else filename }}</h1>
                <div class="raw-filename">File: {{ filename }}</div>

                <div class="meta-row">
                    {% if meta.rating %}<span class="rating">‚òÖ {{ "%.1f"|format(meta.rating) }}</span>{% endif %}
                    <span>{{ meta.year }}</span>
                    <span class="badge quality-badge">{{ quality }}</span>
                    <span class="badge">{{ container }}</span>
                    <span class="badge">{{ file_size }}</span>
                </div>

                {% if container == "MKV" %}
                <div style="margin-bottom: 20px; font-size: 13px; color: #ff8800; background: rgba(255,136,0,0.1); padding: 8px; border-radius: 4px; border: 1px solid #ff8800; display: inline-block;">
                    ‚ö†Ô∏è <b>Audio Issue?</b> Browsers cannot play MKV/DTS Audio. Click <b>Play in VLC</b> below.
                </div>
                {% endif %}

                <div class="plot">
                    {% if meta.overview %} {{ meta.overview }} {% else %} No plot summary available. {% endif %}
                </div>

                <div class="actions">
                    <!-- NEW SMART VLC BUTTON -->
                    <button class="btn btn-vlc" onclick="launchVlc()">‚ö†Ô∏è Play in VLC</button>
                    
                    <a href="/download/{{ filepath }}" download class="btn btn-dl">‚¨á Download</a>
                    
                    <button class="btn" onclick="copyStreamLink()">üìã Copy Stream Link</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('videoPlayer');
        const fileId = "{{ file_id }}";
        const streamUrl = "{{ stream_url }}";
        const vlcLink = "{{ vlc_link }}";

        const savedTime = localStorage.getItem(fileId);
        if (savedTime && savedTime > 5) {
            video.currentTime = savedTime;
            document.getElementById('resume-msg').style.display = 'block';
            setTimeout(() => { document.getElementById('resume-msg').style.display = 'none'; }, 3000);
        }
        video.addEventListener('timeupdate', () => {
            localStorage.setItem(fileId, video.currentTime);
            localStorage.setItem(fileId + "_total", video.duration);
        });
        video.addEventListener('ended', () => { localStorage.removeItem(fileId); });

        // --- SMART VLC LAUNCHER ---
        function launchVlc() {
            // 1. Copy link to clipboard silently
            fallbackCopy(streamUrl, true);

            // 2. Try to launch VLC
            window.location.href = vlcLink;

            // 3. Show instructions (because we can't know if step 2 succeeded on PC)
            setTimeout(() => {
                alert("üöÄ Launching VLC...\n\nIf it didn't open automatically:\n1. Open VLC Player on your PC.\n2. Press Ctrl + N.\n3. Paste (Ctrl + V) -> The link is already in your clipboard!");
            }, 500);
        }

        // --- COPY FUNCTIONS ---
        function copyStreamLink() {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(streamUrl).then(() => { 
                    alert("Stream link copied! Open VLC > Ctrl+N > Paste."); 
                }).catch(() => { fallbackCopy(streamUrl, false); });
            } else { fallbackCopy(streamUrl, false); }
        }

        function fallbackCopy(text, silent) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                if (!silent) alert("Stream link copied! Open VLC > Ctrl+N > Paste.");
            } catch (err) { 
                if (!silent) prompt("Copy manually:", text); 
            }
            document.body.removeChild(textArea);
        }
    </script>
</body>
</html>