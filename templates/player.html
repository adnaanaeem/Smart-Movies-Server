<!DOCTYPE html>
<html>
<head>
    <title>{{ meta.title if meta.title else filename }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    
    <!-- PLYR CSS -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    
    <style>
        body { background: #0f0f0f; color: white; margin: 0; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* 1. TOP SPACING BAR (Fixes "Cramped" feeling) */
        .top-header {
            height: 50px;
            width: 100%;
            background: #0f0f0f;
            display: flex;
            align-items: center;
            padding-left: 20px;
            font-size: 14px;
            color: #555;
            border-bottom: 1px solid #222;
        }

        /* PLAYER CONTAINER */
        .player-wrapper { 
            width: 100%; 
            height: 65vh; 
            background: black; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            z-index: 10;
        }
        
        /* CUSTOM PLYR COLORS */
        :root { --plyr-color-main: #e50914; }
        .plyr { width: 100%; height: 100%; }
        
        /* BACK BUTTON */
        .back-btn {
            position: absolute; top: 20px; left: 20px; z-index: 50;
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white; text-decoration: none; 
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; padding-bottom: 4px; transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .back-btn:hover { background: white; color: black; transform: scale(1.1); }

        /* 2. VOLUME OSD (Netflix Style Center Display) */
        #volume-osd {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 20px 30px;
            border-radius: 10px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: none; /* Hidden by default */
            z-index: 60;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            pointer-events: none; /* Let clicks pass through */
            transition: opacity 0.3s;
        }

        /* INFO SECTION */
        .info-container {
            position: relative; padding: 40px;
            background-image: url('{{ meta.backdrop }}');
            background-size: cover; background-position: center;
            min-height: 40vh; box-shadow: inset 0 50px 100px #0f0f0f;
        }
        .info-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, #0f0f0f 10%, rgba(18,18,18,0.95) 60%, rgba(18,18,18,0.8) 100%);
            z-index: 1; backdrop-filter: blur(5px);
        }

        .content { position: relative; z-index: 2; display: flex; gap: 35px; max-width: 1200px; margin: auto; align-items: flex-start; }
        
        .poster-card {
            width: 200px; height: 300px; flex-shrink: 0;
            border-radius: 12px; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            transform: translateY(-60px);
        }
        .poster-card img { width: 100%; height: 100%; object-fit: cover; }

        .text-details { flex-grow: 1; margin-top: 10px; }
        h1 { margin: 0; font-size: 36px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5); font-weight: 700; }
        
        .raw-filename { font-family: 'Consolas', monospace; font-size: 13px; color: #666; margin: 8px 0 20px 0; word-break: break-all; opacity: 0.7; }

        .meta-row { display: flex; gap: 12px; align-items: center; margin-bottom: 25px; color: #bbb; font-size: 15px; flex-wrap: wrap; }
        .badge { border: 1px solid rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; color: #ddd; background: rgba(255,255,255,0.05); }
        .quality-badge { border-color: #e50914; color: #e50914; background: rgba(229, 9, 20, 0.1); }
        .rating { color: #46d369; font-weight: bold; font-size: 16px; margin-right: 10px; }
        .plot { line-height: 1.7; color: #ccc; font-size: 16px; max-width: 800px; margin-bottom: 30px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .actions { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .btn {
            background: #252525; color: white; border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 24px; border-radius: 8px; text-decoration: none;
            display: inline-flex; align-items: center; gap: 10px; font-weight: 600; font-size: 14px;
            transition: all 0.2s ease; cursor: pointer;
        }
        .btn:hover { background: #fff; color: black; transform: translateY(-2px); }
        .btn-vlc { background: rgba(255, 136, 0, 0.1); border-color: #ff8800; color: #ff8800; }
        .btn-vlc:hover { background: #ff8800; color: white; border-color: #ff8800; }
        .btn-dl { border-color: #00aaff; color: #00aaff; background: rgba(0, 170, 255, 0.1); }
        .btn-dl:hover { background: #00aaff; color: white; border-color: #00aaff; }

        @media (max-width: 768px) {
            .player-wrapper { height: 40vh; }
            .content { flex-direction: column; align-items: center; text-align: center; }
            .poster-card { display: none; }
            .meta-row { justify-content: center; }
            .actions { justify-content: center; }
            h1 { font-size: 24px; }
        }
        
        #resume-msg { position:absolute; top: 80px; left: 30px; background: rgba(229, 9, 20, 0.9); color: #fff; padding: 10px 15px; border-radius: 50px; display: none; z-index: 20; font-size: 13px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        /* SHORTCUTS MODAL */
        .shortcuts-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .shortcuts-content { background-color: #1a1a1a; padding: 30px; border: 1px solid #444; border-radius: 12px; width: 90%; max-width: 400px; position: relative; }
        .key-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .key-table td { padding: 10px; border-bottom: 1px solid #333; color: #ccc; }
        .key-table th { text-align: left; padding: 10px; color: #e50914; border-bottom: 1px solid #555; }
        .key-badge { background: #333; border: 1px solid #555; padding: 2px 8px; border-radius: 4px; font-family: monospace; color: white; font-size: 12px; }
    </style>
</head>
<body>

    <!-- 1. TOP SPACING HEADER -->
    <div class="top-header">
        <span>üé¨ Smart Movie Server</span>
    </div>

    <div class="player-wrapper">
        <a href="javascript:history.back()" class="back-btn" title="Back">‚¨Ö</a>
        <div id="resume-msg">üîÑ Resuming playback...</div>
        
        <!-- 2. VISUAL VOLUME OSD -->
        <div id="volume-osd">üîä 100%</div>

        <video id="player" playsinline controls crossorigin>
            <source src="/download/{{ filepath }}" type="video/{{ container|lower if container != 'MKV' else 'mp4' }}">
            {% for sub in subtitles %}
                <track kind="captions" label="{{ sub.label }}" srclang="{{ sub.lang }}" src="{{ sub.src }}" {% if loop.first %}default{% endif %}>
            {% endfor %}
        </video>
    </div>

    <div class="info-container">
        <div class="info-overlay"></div>
        <div class="content">
            {% if meta.poster %}<div class="poster-card"><img src="{{ meta.poster }}"></div>{% endif %}

            <div class="text-details">
                <h1>{{ meta.title if meta.title else filename }}</h1>
                <div class="raw-filename">{{ filename }}</div>

                <div class="meta-row">
                    {% if meta.rating %}<span class="rating">‚òÖ {{ "%.1f"|format(meta.rating) }}</span>{% endif %}
                    <span>{{ meta.year }}</span>
                    <span class="badge quality-badge">{{ quality }}</span>
                    <span class="badge">{{ container }}</span>
                    <span class="badge">{{ file_size }}</span>
                </div>

                {% if container == "MKV" %}
                <div style="margin-bottom: 20px; font-size: 13px; color: #ff8800; background: rgba(255,136,0,0.1); padding: 10px; border-radius: 6px; border: 1px solid #ff8800; display: inline-block;">
                    ‚ö†Ô∏è <b>No Audio?</b> MKV surround sound is not supported by browsers. <br>Use the <b>VLC button</b> below for full audio.
                </div>
                {% endif %}

                <div class="plot">{% if meta.overview %} {{ meta.overview }} {% else %} No plot summary available. {% endif %}</div>

                <div class="actions">
                    <button class="btn btn-vlc" onclick="launchVlc()">‚ö†Ô∏è Play in VLC</button>
                    <a href="/download/{{ filepath }}" download class="btn btn-dl">‚¨á Download</a>
                    
                    <!-- 3. SHORTCUTS BUTTON -->
                    <button class="btn" onclick="openShortcuts()">‚å®Ô∏è Shortcuts</button>
                    
                    <button class="btn" onclick="copyStreamLink()">üìã Copy Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SHORTCUTS MODAL -->
    <div id="shortcutsModal" class="shortcuts-modal" onclick="closeShortcuts(event)">
        <div class="shortcuts-content">
            <h3 style="margin-top:0; color:white;">‚å®Ô∏è Keyboard Controls</h3>
            <table class="key-table">
                <tr><th>Action</th><th>Key</th></tr>
                <tr><td>Play / Pause</td><td><span class="key-badge">Space</span> or <span class="key-badge">K</span></td></tr>
                <tr><td>Fullscreen</td><td><span class="key-badge">F</span></td></tr>
                <tr><td>Seek Backward</td><td><span class="key-badge">‚¨Ö Left Arrow</span></td></tr>
                <tr><td>Seek Forward</td><td><span class="key-badge">‚û° Right Arrow</span></td></tr>
                <tr><td>Volume Up</td><td><span class="key-badge">‚¨Ü Up Arrow</span></td></tr>
                <tr><td>Volume Down</td><td><span class="key-badge">‚¨á Down Arrow</span></td></tr>
                <tr><td>Mute</td><td><span class="key-badge">M</span></td></tr>
            </table>
            <div style="margin-top:20px; text-align:center; color:#666; font-size:12px;">Click outside to close</div>
        </div>
    </div>

    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        const player = new Plyr('#player', {
            controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
            settings: ['speed', 'quality'],
            speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
            keyboard: { focused: true, global: true },
            seekTime: 10,
        });

        const fileId = "{{ file_id }}";
        const streamUrl = "{{ stream_url }}";
        const vlcLink = "{{ vlc_link }}";

        // --- VOLUME OSD LOGIC ---
        let osdTimeout;
        const osd = document.getElementById('volume-osd');

        player.on('volumechange', event => {
            if(player.muted) {
                osd.innerText = "üîá Muted";
            } else {
                const vol = Math.round(player.volume * 100);
                let icon = vol > 50 ? "üîä" : vol > 0 ? "üîâ" : "üîá";
                osd.innerText = `${icon} ${vol}%`;
            }
            
            // Show OSD
            osd.style.display = "block";
            osd.style.opacity = "1";
            
            // Hide after 1.5 seconds
            clearTimeout(osdTimeout);
            osdTimeout = setTimeout(() => {
                osd.style.opacity = "0";
                setTimeout(() => { osd.style.display = "none"; }, 300);
            }, 1000);
        });

        // --- RESUME LOGIC ---
        const savedTime = localStorage.getItem(fileId);
        player.on('ready', event => {
            if (savedTime && savedTime > 5) {
                player.currentTime = parseFloat(savedTime);
                document.getElementById('resume-msg').style.display = 'block';
                setTimeout(() => { document.getElementById('resume-msg').style.display = 'none'; }, 3000);
            }
            player.elements.container.focus();
        });

        player.on('timeupdate', event => {
            localStorage.setItem(fileId, player.currentTime);
            localStorage.setItem(fileId + "_total", player.duration);
        });
        player.on('ended', event => { localStorage.removeItem(fileId); });

        // --- UTILS ---
        function launchVlc() {
            fallbackCopy(streamUrl, true);
            window.location.href = vlcLink;
            setTimeout(() => { alert("üöÄ Launching VLC...\n\nIf it didn't open:\n1. Open VLC.\n2. Ctrl + N.\n3. Ctrl + V."); }, 500);
        }

        function copyStreamLink() {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(streamUrl).then(() => { alert("Stream link copied!"); }).catch(() => { fallbackCopy(streamUrl, false); });
            } else { fallbackCopy(streamUrl, false); }
        }

        function fallbackCopy(text, silent) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                if (!silent) alert("Stream link copied!");
            } catch (err) { if (!silent) prompt("Copy:", text); }
            document.body.removeChild(textArea);
        }

        function openShortcuts() { document.getElementById('shortcutsModal').style.display = "flex"; }
        function closeShortcuts(e) { if(e.target.id === 'shortcutsModal') document.getElementById('shortcutsModal').style.display = "none"; }
    </script>
</body>
</html>