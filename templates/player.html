<!DOCTYPE html>
<html>
<head>
    <title>{{ meta.title if meta.title else filename }}</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    
    <!-- PLYR CSS -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    
    <style>
        body { background: #0f0f0f; color: white; margin: 0; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* 1. TOP SPACING BAR */
        .top-header {
            height: 50px; width: 100%; background: #0f0f0f;
            display: flex; align-items: center; padding-left: 20px;
            font-size: 14px; color: #555; border-bottom: 1px solid #222;
        }

        /* PLAYER CONTAINER */
        .player-wrapper { 
            width: 100%; height: 65vh; background: black; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; box-shadow: 0 10px 50px rgba(0,0,0,0.8); z-index: 10;
        }
        
        :root { --plyr-color-main: #e50914; }
        .plyr { width: 100%; height: 100%; }
        
        /* BACK BUTTON */
        .back-btn {
            position: absolute; top: 20px; left: 20px; z-index: 50;
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white; text-decoration: none; 
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; padding-bottom: 4px; transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .back-btn:hover { background: white; color: black; transform: scale(1.1); }

        /* VOLUME OSD */
        #volume-osd {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7); padding: 20px 30px; border-radius: 10px;
            color: white; font-size: 24px; font-weight: bold; display: none;
            z-index: 60; backdrop-filter: blur(5px); pointer-events: none; transition: opacity 0.3s;
        }

        /* LOADING SPINNER */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 60; display: flex; align-items: center; justify-content: center;
            pointer-events: none; transition: opacity 0.3s ease;
        }
        .spinner {
            width: 60px; height: 60px; border: 5px solid rgba(255,255,255,0.1);
            border-top: 5px solid #e50914; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* INFO SECTION */
        .info-container {
            position: relative; padding: 40px;
            background-image: url('{{ meta.backdrop }}');
            background-size: cover; background-position: center;
            min-height: 40vh; box-shadow: inset 0 50px 100px #0f0f0f;
        }
        .info-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, #0f0f0f 10%, rgba(18,18,18,0.95) 60%, rgba(18,18,18,0.8) 100%);
            z-index: 1; backdrop-filter: blur(5px);
        }

        .content { position: relative; z-index: 2; display: flex; gap: 35px; max-width: 1200px; margin: auto; align-items: flex-start; }
        
        .poster-card {
            width: 200px; height: 300px; flex-shrink: 0; border-radius: 12px; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1); transform: translateY(-60px);
        }
        .poster-card img { width: 100%; height: 100%; object-fit: cover; }

        .text-details { flex-grow: 1; margin-top: 10px; }
        h1 { margin: 0; font-size: 36px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5); font-weight: 700; }
        .raw-filename { font-family: 'Consolas', monospace; font-size: 13px; color: #666; margin: 8px 0 20px 0; word-break: break-all; opacity: 0.7; }

        .meta-row { display: flex; gap: 12px; align-items: center; margin-bottom: 25px; color: #bbb; font-size: 15px; flex-wrap: wrap; }
        .badge { border: 1px solid rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; color: #ddd; background: rgba(255,255,255,0.05); }
        .quality-badge { border-color: #e50914; color: #e50914; background: rgba(229, 9, 20, 0.1); }
        .rating { color: #46d369; font-weight: bold; font-size: 16px; margin-right: 10px; }
        .plot { line-height: 1.7; color: #ccc; font-size: 16px; max-width: 800px; margin-bottom: 30px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .actions { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .btn {
            background: #252525; color: white; border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 24px; border-radius: 8px; text-decoration: none;
            display: inline-flex; align-items: center; gap: 10px; font-weight: 600; font-size: 14px;
            transition: all 0.2s ease; cursor: pointer;
        }
        .btn:hover { background: #fff; color: black; transform: translateY(-2px); }
        .btn-vlc { background: rgba(255, 136, 0, 0.1); border-color: #ff8800; color: #ff8800; }
        .btn-dl { border-color: #00aaff; color: #00aaff; background: rgba(0, 170, 255, 0.1); }

        @media (max-width: 768px) {
            .player-wrapper { height: 40vh; }
            .content { flex-direction: column; align-items: center; text-align: center; }
            .poster-card { display: none; }
            .meta-row { justify-content: center; }
            .actions { justify-content: center; }
            h1 { font-size: 24px; }
        }
        
        #resume-msg { position:absolute; top: 80px; left: 30px; background: rgba(229, 9, 20, 0.9); color: #fff; padding: 10px 15px; border-radius: 50px; display: none; z-index: 20; font-size: 13px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        .shortcuts-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .shortcuts-content { background-color: #1a1a1a; padding: 30px; border: 1px solid #444; border-radius: 12px; width: 90%; max-width: 400px; position: relative; }
        .key-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .key-table td { padding: 10px; border-bottom: 1px solid #333; color: #ccc; }
        .key-table th { text-align: left; padding: 10px; color: #e50914; border-bottom: 1px solid #555; }
        .key-badge { background: #333; border: 1px solid #555; padding: 2px 8px; border-radius: 4px; font-family: monospace; color: white; font-size: 12px; }
    </style>
</head>
<body>

    <div class="top-header"><span>üé¨ Smart Movie Server</span></div>

    <!-- THIS IS THE CORRECT STRUCTURE -->
    <div class="player-wrapper">
        <a href="javascript:history.back()" class="back-btn" title="Back">‚¨Ö</a>
        <div id="resume-msg">üîÑ Resuming playback...</div>
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="loader-overlay">
            <div class="spinner"></div>
        </div>
        
        <!-- Volume OSD -->
        <div id="volume-osd">üîä 100%</div>

        <!-- Single Video Tag -->
        <video id="player" playsinline controls crossorigin>
            <source src="{{ stream_url }}" type="video/{{ container|lower if container != 'MKV' else 'mp4' }}">
            {% for sub in subtitles %}
                <track kind="captions" label="{{ sub.label }}" srclang="{{ sub.lang }}" src="{{ sub.src }}" {% if loop.first %}default{% endif %}>
            {% endfor %}
        </video>
    </div>

    <div class="info-container">
        <div class="info-overlay"></div>
        <div class="content">
            {% if meta.poster %}<div class="poster-card"><img src="{{ meta.poster }}"></div>{% endif %}

            <div class="text-details">
                <h1>{{ meta.title if meta.title else filename }}</h1>
                <div class="raw-filename">{{ filename }}</div>

                <div class="meta-row">
                    {% if meta.rating %}<span class="rating">‚òÖ {{ "%.1f"|format(meta.rating) }}</span>{% endif %}
                    <span>{{ meta.year }}</span>
                    <span class="badge quality-badge">{{ quality }}</span>
                    <span class="badge">{{ container }}</span>
                    <span class="badge">{{ file_size }}</span>
                </div>

                {% if container == "MKV" %}
                <div style="margin-bottom: 20px; font-size: 13px; color: #ff8800; background: rgba(255,136,0,0.1); padding: 10px; border-radius: 6px; border: 1px solid #ff8800; display: inline-block;">
                    ‚ö†Ô∏è <b>No Audio?</b> MKV surround sound is not supported by browsers. <br>Use the <b>VLC button</b> below for full audio.
                </div>
                {% endif %}

                <div class="plot">{% if meta.overview %} {{ meta.overview }} {% else %} No plot summary available. {% endif %}</div>

                <div class="actions">
                    <button class="btn" id="watch-party-btn" onclick="createWatchParty()">üéâ Watch Party</button>
                    <button class="btn btn-vlc" onclick="launchVlc()">‚ö†Ô∏è Play in VLC</button>
                    <a href="/download/{{ filepath }}" download class="btn btn-dl">‚¨á Download</a>
                    <button class="btn" onclick="openShortcuts()">‚å®Ô∏è Shortcuts</button>
                    <button class="btn" onclick="copyStreamLink()">üìã Copy Link</button>
                </div>
            </div>
        </div>
    </div>

    <div id="shortcutsModal" class="shortcuts-modal" onclick="closeShortcuts(event)">
        <div class="shortcuts-content">
            <h3 style="margin-top:0; color:white;">‚å®Ô∏è Keyboard Controls</h3>
            <table class="key-table">
                <tr><th>Action</th><th>Key</th></tr>
                <tr><td>Play / Pause</td><td><span class="key-badge">Space</span> or <span class="key-badge">K</span></td></tr>
                <tr><td>Fullscreen</td><td><span class="key-badge">F</span></td></tr>
                <tr><td>Seek Backward</td><td><span class="key-badge">‚¨Ö Left Arrow</span></td></tr>
                <tr><td>Seek Forward</td><td><span class="key-badge">‚û° Right Arrow</span></td></tr>
                <tr><td>Volume Up</td><td><span class="key-badge">‚¨Ü Up Arrow</span></td></tr>
                <tr><td>Volume Down</td><td><span class="key-badge">‚¨á Down Arrow</span></td></tr>
            </table>
        </div>
    </div>

<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script>
    const player = new Plyr('#player', {
        /* plyr options */
        autoplay: false, // Important for sync
        keyboard: { focused: true, global: true },
        seekTime: 10,
    });

    const fileId = "{{ file_id }}";
    const vlcLink = "{{ vlc_link }}";
    const streamUrl = "{{ stream_url }}";

    // --- WATCH PARTY LOGIC ---
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    let partyRoom = urlParams.get('party'); // Check if we joined a party link
    let isSyncing = false; // Flag to prevent event loops

    // Connect to the socket server and join the room if in a party
    socket.on('connect', () => {
        if (partyRoom) {
            socket.emit('join_room', { room: partyRoom });
            document.getElementById('watch-party-btn').innerText = "üéâ In Party!";
            document.getElementById('watch-party-btn').style.borderColor = "#28a745";
        }
    });

    // Listen for events from the server
    socket.on('server_event', (data) => {
        isSyncing = true; // Prevent sending this event back to server
        console.log('Received from server:', data);
        switch (data.event) {
            case 'play':
                // If the host is playing, we should also be playing at their time
                player.currentTime = data.time;
                player.play();
                break;
            case 'pause':
                // If the host paused, we must also pause
                player.pause();
                break;
            case 'seeked':
                // The host jumped to a new time. We must follow.
                player.currentTime = data.time;
                // And we must match their play/pause state *after* seeking.
                if (data.paused) {
                    player.pause();
                } else {
                    player.play();
                }
                break;
        }
        // After a short delay, reset the flag
        setTimeout(() => { isSyncing = false; }, 200);
    });

    // Function to send our events to the server
    function sendPlayerEvent(event, time) {
        if (partyRoom && !isSyncing) {
            socket.emit('player_event', {
                room: partyRoom,
                event: event,
                time: time,
                paused: player.paused
            });
        }
    }

    // Attach listeners to our local player
    player.on('play', () => sendPlayerEvent('play', player.currentTime));
    player.on('pause', () => sendPlayerEvent('pause', player.currentTime));
    player.on('seeked', () => sendPlayerEvent('seeked', player.currentTime));

    // UI function to create a party
    // UI function to create a party (FIXED FOR HTTP)
    function createWatchParty() {
        if (partyRoom) {
            // If already in a party, just copy the link again
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert("You are already in a party! The invite link has been copied to your clipboard again.");
            }).catch(() => {
                prompt("You are already in a party! Copy this link to invite others:", window.location.href);
            });
            return;
        }
        
        // Generate a simple unique ID for the party room
        const newPartyId = fileId + '-' + Math.random().toString(36).substring(2, 8);
        const partyUrl = window.location.href.split('?')[0] + '?party=' + newPartyId;
        
        // --- Smart Copy Logic ---
        // Check if the modern, secure clipboard API is available
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(partyUrl).then(() => {
                alert("‚úÖ Watch Party link copied!\n\nThe page will now reload into party mode.");
                window.location.href = partyUrl;
            });
        } else {
            // Fallback for insecure (http) connections
            prompt("Copy this Watch Party link and share it with friends:", partyUrl);
            alert("The page will now reload into party mode.");
            window.location.href = partyUrl;
        }
    }

    // --- SPINNER & RESUME LOGIC (Unaffected) ---
    const spinner = document.getElementById('loading-spinner');
    function hideSpinner() { spinner.style.opacity = '0'; setTimeout(() => spinner.style.display = 'none', 300); }
    function showSpinner() { spinner.style.display = 'flex'; spinner.style.opacity = '1'; }
    player.on('ready', hideSpinner); player.on('playing', hideSpinner); player.on('pause', hideSpinner);
    player.on('waiting', showSpinner); player.on('seeking', showSpinner); player.on('seeked', hideSpinner);

    player.on('ready', event => {
        const savedTime = localStorage.getItem(fileId);
        if (savedTime && !partyRoom) { // Only resume from local storage if NOT in a party
            player.currentTime = parseFloat(savedTime);
        }
        player.play().catch(()=>{});
    });

    // --- OTHER UTILS ---
    function launchVlc() { window.location.href = vlcLink; }
    function copyStreamLink() { navigator.clipboard.writeText(streamUrl).then(() => alert("Copied!")).catch(() => prompt("Copy:", streamUrl)); }
</script>
</body>
</html>